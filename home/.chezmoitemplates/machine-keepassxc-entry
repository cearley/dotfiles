{{- /* Retrieve KeePassXC entry name from machines.yaml based on computer name pattern.

     Uses the generic machine-config template to lookup the keepassxc entry from machines.yaml.

     Parameters (pass as dict merged with root context):
     - entry (required): Name of the KeePassXC entry to retrieve (e.g., "ssh")

     Examples:
       Get SSH entry:  {{ includeTemplate "machine-keepassxc-entry" (merge (dict "entry" "ssh") .) }}

     Returns:
     - The KeePassXC entry name (e.g., "SSH (Macbook Pro)") or empty string if not found
*/ -}}
{{- if not (hasKey . "entry") -}}
  {{- fail "machine-keepassxc-entry template requires 'entry' parameter" -}}
{{- end -}}
{{- $entry := .entry -}}
{{- $machineConfig := includeTemplate "machine-config" (merge (dict "setting" "keepassxc") .) -}}
{{- $result := "" -}}
{{- if $machineConfig -}}
  {{- /* machine-config returns the entire keepassxc dict, navigate to entrys */ -}}
  {{- $computerName := includeTemplate "computer-name" . -}}
  {{- /* Find matching machine pattern again to access nested structure */ -}}
  {{- range $pattern, $config := . -}}
    {{- if and (ne $pattern "chezmoi") (ne $pattern "entry") (contains $pattern $computerName) -}}
      {{- if and (hasKey $config "keepassxc") (hasKey $config.keepassxc "entrys") -}}
        {{- if hasKey $config.keepassxc.entrys $entry -}}
          {{- $result = index $config.keepassxc.entrys $entry -}}
        {{- end -}}
      {{- end -}}
      {{- break -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
{{- $result -}}
