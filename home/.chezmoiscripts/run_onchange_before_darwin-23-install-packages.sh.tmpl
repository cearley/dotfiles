{{ if eq .chezmoi.os "darwin" -}}
#!/bin/bash

source "{{ .chezmoi.sourceDir -}}/scripts/shared-utils.sh"

if ! require_tools brew; then
    exit 1
fi

print_message "info" "Installing packages using Homebrew..."

{{- $icloudAccountId := includeTemplate "icloud-account-id" . | trim -}}
{{- $icloudSignedIn := ne $icloudAccountId "" -}}
{{ if not $icloudSignedIn -}}
print_message "warning" "Not signed into iCloud - Mac App Store packages will be skipped"
{{ end -}}

brew update && brew bundle --file=/dev/stdin <<EOF
{{- range .packages.darwin.taps }}
tap {{ . | quote }}
{{- end }}

{{- $categories := prepend .tag_choices "core" }}
{{- range $category := $categories }}
  {{- $categoryData := index $.packages.darwin $category }}
  {{- if or (eq $category "core") (has $category $.tags) }}

# Install {{ $category }} packages
    {{- if and (hasKey $categoryData "taps") $categoryData.taps }}
{{ range $categoryData.taps -}}
tap {{ . | quote }}
{{ end -}}
    {{- end }}

    {{- if and (hasKey $categoryData "brews") $categoryData.brews }}
{{ range $categoryData.brews -}}
brew {{ . | quote }}
{{ end -}}
    {{- end }}

    {{- if and (hasKey $categoryData "casks") $categoryData.casks }}
{{ range $categoryData.casks -}}
cask {{ . | quote }}
{{ end -}}
    {{- end }}

    {{- if and $icloudSignedIn (hasKey $categoryData "mas") $categoryData.mas }}
{{ range $categoryData.mas -}}
mas {{ . }}
{{ end -}}
    {{- end }}
  {{- end }}
{{- end }}
EOF

{{ if not $icloudSignedIn -}}
print_message "info" "Sign in to iCloud in System Settings, then run 'chezmoi apply' again to install App Store apps"
{{ end -}}
{{ end -}}
