{{ if eq .chezmoi.os "darwin" -}}
#!/bin/bash

# Source shared utility functions
source "{{ .chezmoi.sourceDir -}}/scripts/script-utils.sh"

# Check required tools
if ! require_tools brew; then
    exit 1
fi

print_message "info" "Installing packages using Homebrew..."

brew bundle --file=/dev/stdin <<EOF
{{- range .packages.darwin.taps }}
tap {{ . | quote }}
{{- end }}

{{- $categories := list "core" "dev" "ai" "work" "mobile" }}
{{- range $category := $categories }}
  {{- $categoryData := index $.packages.darwin $category }}
  {{- if or (eq $category "core") (has $category $.tags) }}

# Install {{ $category }} packages
    {{- if $categoryData.brews }}
{{ range $categoryData.brews -}}
brew {{ . | quote }}
{{ end -}}
    {{- end }}

    {{- if $categoryData.casks }}
{{ range $categoryData.casks -}}
cask {{ . | quote }}
{{ end -}}
    {{- end }}
  {{- end }}
{{- end }}
EOF

# Install Mac App Store packages (only if signed into iCloud)
if is_icloud_signed_in; then
    print_message "info" "Installing Mac App Store packages..."
    brew bundle --file=/dev/stdin <<EOF
{{- $categories := list "core" "dev" "ai" "work" "mobile" }}
{{- range $category := $categories }}
  {{- $categoryData := index $.packages.darwin $category }}
  {{- if or (eq $category "core") (has $category $.tags) }}
    {{- if $categoryData.mas }}

# {{ $category }} Mac App Store packages
{{ range $categoryData.mas -}}
mas {{ . }}
{{ end -}}
    {{- end }}
  {{- end }}
{{- end }}
EOF
else
    print_message "warning" "Not signed into iCloud - Mac App Store packages will be skipped"
    print_message "info" "Sign in to iCloud in System Settings, then run 'chezmoi apply' again to install App Store apps"
fi

{{- if has "dev" .tags }}
print_message "info" "Installing packages using SDKMAN!..."

if ! command_exists sdk; then
  # Initialize SDKMAN assuming it's installed
  source "{{- .chezmoi.homeDir -}}/.sdkman/bin/sdkman-init.sh"
fi

{{ range .packages.darwin.dev.sdk -}}
sdk install {{ . }}
{{ end -}}
{{- end }} # if has "dev" .tags

{{ end -}}