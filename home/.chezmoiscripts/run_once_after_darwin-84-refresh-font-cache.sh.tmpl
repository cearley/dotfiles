{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash

# Source shared utility functions
source "{{ .chezmoi.sourceDir -}}/scripts/script-utils.sh"

# Check if fonts were recently installed (within last 10 minutes)
# This makes the script more idempotent - only refresh if new fonts detected
FONT_DIRS=(
    "$HOME/Library/Fonts"
    "/Library/Fonts"
)

recent_fonts_found=false
for font_dir in "${FONT_DIRS[@]}"; do
    if [ -d "$font_dir" ]; then
        # Check for fonts modified in last 10 minutes
        if find "$font_dir" -type f \( -name "*.ttf" -o -name "*.otf" -o -name "*.ttc" \) -mmin -10 2>/dev/null | grep -q .; then
            recent_fonts_found=true
            break
        fi
    fi
done

if [ "$recent_fonts_found" = false ]; then
    print_message "skip" "Skipping font cache refresh: no recently installed fonts detected"
    exit 0
fi

print_message "info" "Refreshing font cache to register newly installed fonts..."

# Restart the font daemon (fontd) to re-scan installed fonts
# Killing fontd is safe - macOS will automatically respawn it
if killall fontd 2>/dev/null; then
    print_message "success" "Font daemon restarted - new fonts are now available"
    # Give fontd a moment to respawn and re-scan fonts
    sleep 2
else
    print_message "warning" "Font daemon not found or could not restart"
    print_message "info" "Fonts will be available after logout/login"
fi

{{ end -}}
