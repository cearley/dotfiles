{{- if and (eq .chezmoi.os "darwin") (has "ai" .tags) (not (has "dev" .tags)) -}}
{{- /* On machines with dev tag, this is installed in .chezmoiexternal.toml.tmpl */ -}}
#!/bin/bash

# Chezmoi script to install or upgrade zsh-llm-suggestions via uv.
# This script runs after chezmoi applies other changes on macOS.
# It will upgrade the package if it detects changes in the installed version.

# Source shared utility functions
source "{{ .chezmoi.sourceDir -}}/scripts/script-utils.sh"

if ! require_tools uv; then
    exit 1
fi

set -e

ZSH_LLM_REPO="git+https://github.com/cearley/zsh-llm-suggestions"
TOOL_NAME="zsh-llm-suggestions"

{{ $path := joinPath .chezmoi.homeDir ".local/bin" -}}
{{ if findExecutable "zsh-llm-status" $path -}}
# zsh-llm-status hash: {{ output "zsh-llm-status" | sha256sum }}
print_message "info" "Upgrading $TOOL_NAME to latest version..."
if uv tool upgrade "$TOOL_NAME"; then
    print_message "success" "$TOOL_NAME upgraded successfully"
else
    print_message "error" "Failed to upgrade $TOOL_NAME"
    exit 1
fi
{{- else }}
print_message "info" "Installing $TOOL_NAME..."
if uv tool install "$ZSH_LLM_REPO"; then
    zsh-llm-install
    print_message "success" "$TOOL_NAME installed successfully"
else
    print_message "error" "Failed to install $TOOL_NAME"
    exit 1
fi
{{- end }}

{{ end -}}
