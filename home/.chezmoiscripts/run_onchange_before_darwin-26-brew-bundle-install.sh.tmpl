{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash

source "{{ .chezmoi.sourceDir -}}/scripts/shared-utils.sh"

if ! require_tools brew scutil; then
    exit 1
fi

# This script installs additional packages using Homebrew based on the specific computer name.
#
# Maintenance: Update brewfiles by periodically running:
# brew bundle dump --file=$HOME/Brewfile --force
{{ $settings := includeTemplate "machine-settings" . | fromJson }}
{{- $brewfile := index $settings "brewfile" -}}
{{- if $brewfile -}}
  {{- $brewfilePath := printf "%s/brewfiles/%s" .chezmoi.sourceDir $brewfile -}}
  {{- if stat $brewfilePath -}}
brewfile={{ $brewfilePath }}
# brewfile hash: {{ include $brewfilePath | sha256sum }}
  {{- else -}}
brewfile=""
  {{- end -}}
{{- else -}}
brewfile=""
{{- end }}
{{- $computerName := includeTemplate "machine-name" . }}

if [[ ! -f $brewfile ]]; then
    print_message "skip" "Skipping additional package installation - brewfile not found for this machine ({{- $computerName -}})"
    print_message "tip" "You can create a brewfile at '{{ .chezmoi.sourceDir }}/brewfiles/your-brewfile' and update '{{ .chezmoi.sourceDir }}/.chezmoidata/config.yaml' to point to it."
    exit 0
fi

if brew bundle check --file=$brewfile >/dev/null 2>&1; then
    print_message "skip" "Skipping additional package installation - all packages already installed"
    exit 0
fi

read -p "üç∫ Install additional packages from your brewfile? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    print_message "skip" "Skipping additional package installation"
    exit 0
fi

print_message "info" "Installing additional packages using Homebrew..."

{{- $icloudAccountId := includeTemplate "icloud-account-id" . | trim }}
{{- $icloudSignedIn := ne $icloudAccountId "" }}

{{ if not $icloudSignedIn -}}
print_message "warning" "Not signed into iCloud - Mac App Store packages will be skipped"
{{ end -}}

{{ if $icloudSignedIn -}}
    HOMEBREW_ACCEPT_EULA=Y brew bundle -v --file=$brewfile
{{- else -}}
    HOMEBREW_ACCEPT_EULA=Y HOMEBREW_BUNDLE_MAS_SKIP=1 brew bundle -v --file=$brewfile
{{ end -}}

{{ if not $icloudSignedIn -}}
print_message "info" "Sign in to iCloud in System Settings, then run 'chezmoi apply' again to install App Store apps"
{{ end -}}

{{ end -}}