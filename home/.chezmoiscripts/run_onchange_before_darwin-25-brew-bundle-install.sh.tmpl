{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash

# Source shared utility functions
source "{{ .chezmoi.sourceDir -}}/scripts/script-utils.sh"

# Check required tools
if ! require_tools brew scutil; then
    exit 1
fi

# This script installs supplemental packages using Homebrew based on the 
# specific Mac computer name.
# 
# Maintenance: Update brewfiles by periodically running:
# brew bundle dump --file=$HOME/.brewfiles/{machine-specific-brewfile} --force

{{ $computerName := includeTemplate "computer-name" . }}
{{- $brewfilePath := includeTemplate "machine-brewfile-path" (dict "computerName" $computerName "chezmoi" .chezmoi) -}}
{{- if $brewfilePath -}}
brewfile={{ $brewfilePath }}
# brewfile hash: {{ include $brewfilePath | sha256sum }}
{{- else -}}
brewfile=""
{{- end }}

if [[ ! -f $brewfile ]]; then
    print_message "skip" "Skipping supplemental package installation - brewfile not found for this machine ({{- $computerName -}})"
    exit 0
fi

read -p "üç∫ Install additional packages from your brewfile? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    print_message "skip" "Skipping supplemental package installation"
    exit 0
fi

print_message "info" "Installing supplemental packages using Homebrew..."

brew bundle -v --no-lock --file=$brewfile
{{ end -}}