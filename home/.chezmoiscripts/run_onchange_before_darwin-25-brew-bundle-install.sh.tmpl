{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash

# Source shared utility functions
source "{{ .chezmoi.sourceDir -}}/scripts/script-utils.sh"

# Check required tools
if ! require_tools brew scutil; then
    exit 1
fi

# MacOS-specific script to install supplemental packages using Homebrew
# This script uses separate brewfiles (mbp-brewfile, studio-brewfile) for machine-specific packages
# that extend beyond the core/essential packages defined in packages.yaml.
# packages.yaml contains static, essential packages categorized by tags (core, dev, ai, work)
# while this script handles supplemental, machine-specific, or experimental package installations.
# 
# Maintenance: Update brewfiles by periodically running:
# brew bundle dump --file=$HOME/.brewfiles/{machine-specific-brewfile} --force

# Prompt user whether to install supplemental packages
read -p "üç∫ Install additional packages from your brewfile? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    print_message "skip" "Skipping supplemental package installation"
    exit 0
fi

print_message "info" "Installing supplemental packages using Homebrew..."

{{ $computerName := output "scutil" "--get" "ComputerName" | trim }}
{{ if contains "MacBook Pro" $computerName -}}
brewfile="{{ .chezmoi.sourceDir }}/mbp-brewfile"
{{- else if contains "Mac Studio" $computerName -}}
brewfile="{{ .chezmoi.sourceDir }}/studio-brewfile"
{{- else -}}
brewfile=""
{{- end }}

# mbp-brewfile hash: {{ include (joinPath .chezmoi.sourceDir "mbp-brewfile") | sha256sum }}
# studio-brewfile hash: {{ include (joinPath .chezmoi.sourceDir "studio-brewfile") | sha256sum }}
brew bundle -v --no-lock --file=$brewfile
{{ end -}}