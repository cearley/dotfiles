{{- if and (eq .chezmoi.os "darwin") .microsoft_email -}}
#!/bin/bash

set -eufo pipefail

# Source shared utility functions
source "{{ .chezmoi.sourceDir -}}/scripts/script-utils.sh"

print_message "info" "Setting up Microsoft Defender for Individuals..."

# Check if Microsoft Defender is already installed
if is_app_installed "/Applications/Microsoft Defender.app"; then
    print_message "success" "Microsoft Defender is already installed"
    exit 0
fi

# Open the Microsoft Defender download page
print_message "info" "Opening Microsoft Defender download page in your default browser..."
open "https://www.microsoft.com/en-us/microsoft-365/microsoft-defender-for-individuals#Download-the-app"

echo ""
print_message "info" "Manual Installation Instructions:"
echo "1. Click 'Download for MacOS' on the page that just opened"
echo "2. Once downloaded, open the installer package"
echo "3. Follow the installation wizard to install Microsoft Defender"
echo "4. After installation, launch Microsoft Defender"
echo "5. Sign in with your Microsoft account: {{ .microsoft_email }}"
echo ""

# Wait a moment for the page to load, then provide additional guidance
sleep 3

print_message "info" "Additional Setup Tips:"
echo "- Microsoft Defender may require Full Disk Access permissions"
echo "- You can grant permissions in System Preferences > Security & Privacy > Privacy > Full Disk Access"
echo "- Add Microsoft Defender to the list of allowed applications"
echo ""

# Wait for the user to complete the installation
if wait_for_app_installation "/Applications/Microsoft Defender.app" "Microsoft Defender"; then
    print_message "info" "Don't forget to sign in with your Microsoft account: {{ .microsoft_email }}"
    print_message "info" "Grant Full Disk Access permissions if prompted for complete protection"
else
    print_message "info" "Microsoft Defender can be manually installed from: https://www.microsoft.com/en-us/microsoft-365/microsoft-defender-for-individuals"
    exit 1
fi

{{ end -}}