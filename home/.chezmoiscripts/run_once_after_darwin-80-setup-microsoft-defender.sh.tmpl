{{- if and (eq .chezmoi.os "darwin") (has "work" .tags) -}}
#!/bin/bash

set -eufo pipefail

source "{{ .chezmoi.sourceDir -}}/scripts/shared-utils.sh"

if is_app_installed "/Applications/Microsoft Defender.app"; then
    print_message "skip" "Skipping Microsoft Defender installation: Microsoft Defender is already installed"
    exit 0
fi

print_message "info" "Setting up Microsoft Defender for Individuals..."

# Open the Microsoft Defender download page
print_message "info" "Opening Microsoft Defender download page in your default browser..."
open "https://www.microsoft.com/en-us/microsoft-365/microsoft-defender-for-individuals#Download-the-app"

echo ""
print_message "info" "Manual Installation Instructions:"
echo "1. Click 'Download for MacOS' on the page that just opened"
echo "2. Once downloaded, open the installer package"
echo "3. Follow the installer wizard to complete installation"
echo ""

if wait_for_app_installation "/Applications/Microsoft Defender.app" "Microsoft Defender"; then
    print_message "success" "Microsoft Defender has been installed successfully!"
    print_message "info" "Post-Installation Setup:"
    echo "1. Launch Microsoft Defender from Applications"
    echo "2. Sign in with your Microsoft account{{ if ne .microsoft_email "" -}}: {{ .microsoft_email }}{{- end }}"
    echo ""
else
    print_message "warning" "Microsoft Defender installation timed out or was cancelled"
    print_message "info" "Microsoft Defender can be manually installed from: https://www.microsoft.com/en-us/microsoft-365/microsoft-defender-for-individuals"
    ech0 ""
fi

prompt_ready "Press any key to continue..."

{{ end -}}