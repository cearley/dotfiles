{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash

# Source shared utility functions
source "{{ .chezmoi.sourceDir -}}/scripts/script-utils.sh"

# Check required tools
if ! require_tools defaults /usr/libexec/PlistBuddy; then
    exit 1
fi

print_message "info" "Configuring macOS system defaults..."

{{- if has "iterm2" .packages.darwin.core.casks }}
# iTerm2: Enable 'Close windows when quitting an application'
defaults write com.googlecode.iterm2 NSQuitAlwaysKeepsWindows -bool true

# iTerm2: Disable 'Clicking on a command selects it to restrict Find and Filter'
defaults write com.googlecode.iterm2 ClickToSelectCommand -bool false

# iTerm2: Load settings from custom folder
defaults write com.googlecode.iterm2 PrefsCustomFolder -string "~/.dotfiles/iTerm/settings"
defaults write com.googlecode.iterm2 LoadPrefsFromCustomFolder -bool false

# iTerm2: Save changes when quitting
defaults write com.googlecode.iterm2 NoSyncNeverRemindPrefsChangesLostForFile -bool true
defaults write com.googlecode.iterm2 NoSyncNeverRemindPrefsChangesLostForFile_selection -int 2

# iTerm2: Set default profile font to MesloLGSNF size 13
/usr/libexec/PlistBuddy -c "Set 'New Bookmarks':0:'Normal Font' 'MesloLGSNF-Regular 13'" ~/Library/Preferences/com.googlecode.iterm2.plist 2>/dev/null || true
{{- end }}

print_message "success" "System defaults configured successfully"
{{ end -}}