{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash

source "{{ .chezmoi.sourceDir -}}/scripts/shared-utils.sh"

if ! require_tools defaults /usr/libexec/PlistBuddy; then
    exit 1
fi

print_message "info" "Configuring macOS system defaults..."

# Set Terminal font to MesloLGSNF size 13 for all profiles
osascript <<'APPLESCRIPT' 2>/dev/null
tell application "Terminal"
    set ProfileNames to name of every settings set
    repeat with ProfileName in ProfileNames
        tell settings set ProfileName
            set font name to "MesloLGSNF-Regular"
            set font size to 13
        end tell
    end repeat
end tell
APPLESCRIPT

if [ $? -eq 0 ]; then
    print_message "success" "Terminal.app fonts set to MesloLGSNF-Regular 13 for all profiles"
else
    print_message "warning" "Could not configure Terminal.app fonts"
fi

{{- if has "iterm2" .packages.darwin.core.casks }}
# iTerm2: Enable 'Close windows when quitting an application'
defaults write com.googlecode.iterm2 NSQuitAlwaysKeepsWindows -bool true

# iTerm2: Disable 'Clicking on a command selects it to restrict Find and Filter'
defaults write com.googlecode.iterm2 ClickToSelectCommand -bool false

# iTerm2: Load settings from custom folder
defaults write com.googlecode.iterm2 PrefsCustomFolder -string "~/.dotfiles/iTerm/settings"
defaults write com.googlecode.iterm2 LoadPrefsFromCustomFolder -bool false

# iTerm2: Save changes when quitting
defaults write com.googlecode.iterm2 NoSyncNeverRemindPrefsChangesLostForFile -bool true
defaults write com.googlecode.iterm2 NoSyncNeverRemindPrefsChangesLostForFile_selection -int 2

# iTerm2: Set default profile font to MesloLGSNF size 13
ITERM_PLIST=~/Library/Preferences/com.googlecode.iterm2.plist

if /usr/libexec/PlistBuddy -c "Set 'New Bookmarks':0:'Normal Font' 'MesloLGSNF-Regular 13'" "$ITERM_PLIST" 2>/dev/null; then
    if pgrep -q "iTerm2"; then
        print_message "warning" "iTerm2 font configured, but restart required for changes to persist"
        print_message "tip" "Quit and reopen iTerm2 to apply font changes"
    else
        print_message "success" "iTerm2 font set to MesloLGSNF-Regular 13"
    fi
else
    print_message "warning" "Could not set iTerm2 font (profile may not exist yet)"
fi
{{- end }}

print_message "success" "System defaults configured successfully"
{{ end -}}