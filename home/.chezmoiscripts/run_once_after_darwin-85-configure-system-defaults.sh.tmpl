{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash

source "{{ .chezmoi.sourceDir -}}/scripts/shared-utils.sh"

if ! require_tools defaults /usr/libexec/PlistBuddy; then
    exit 1
fi

print_message "info" "Configuring macOS system defaults..."

# Set Terminal default font to MesloLGSNF size 13
defaults write com.apple.terminal "Default Window Settings" -string "MesloLGSNF-Regular 13"
defaults write com.apple.terminal "Startup Window Settings" -string "MesloLGSNF-Regular 13"

{{- if has "iterm2" .packages.darwin.core.casks }}
# iTerm2: Enable 'Close windows when quitting an application'
defaults write com.googlecode.iterm2 NSQuitAlwaysKeepsWindows -bool true

# iTerm2: Disable 'Clicking on a command selects it to restrict Find and Filter'
defaults write com.googlecode.iterm2 ClickToSelectCommand -bool false

# iTerm2: Load settings from custom folder
defaults write com.googlecode.iterm2 PrefsCustomFolder -string "~/.dotfiles/iTerm/settings"
defaults write com.googlecode.iterm2 LoadPrefsFromCustomFolder -bool false

# iTerm2: Save changes when quitting
defaults write com.googlecode.iterm2 NoSyncNeverRemindPrefsChangesLostForFile -bool true
defaults write com.googlecode.iterm2 NoSyncNeverRemindPrefsChangesLostForFile_selection -int 2

# iTerm2: Set default profile font to MesloLGSNF size 13
# Note: This requires iTerm2 to be quit first, otherwise changes may be overwritten
if pgrep -q "iTerm2"; then
    print_message "warning" "iTerm2 is running - font changes may not persist until restart"
fi

if /usr/libexec/PlistBuddy -c "Set 'New Bookmarks':0:'Normal Font' 'MesloLGSNF-Regular 13'" ~/Library/Preferences/com.googlecode.iterm2.plist 2>/dev/null; then
    print_message "success" "iTerm2 font set to MesloLGSNF-Regular 13"
else
    print_message "warning" "Could not set iTerm2 font (profile may not exist yet)"
fi
{{- end }}

print_message "success" "System defaults configured successfully"
{{ end -}}